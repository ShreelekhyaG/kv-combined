<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QueryService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">queryEngine</a> &gt; <a href="index.source.html" class="el_package">com.stackroute.knowledgevault.queryengine.service</a> &gt; <span class="el_source">QueryService.java</span></div><h1>QueryService.java</h1><pre class="source lang-java linenums">package com.stackroute.knowledgevault.queryengine.service;

import com.stackroute.knowledgevault.domain.ExtractedFileData;
import com.stackroute.knowledgevault.domain.OutputResult;
import com.stackroute.knowledgevault.domain.ParaContent;
import org.neo4j.driver.v1.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.*;

@Service
public class QueryService {

    private ParaContentService paraContentService;
    private ExtractedDataService extractedDataService;
    Set&lt;String&gt; symset;
    Set&lt;String&gt; anaset;
    Set&lt;String&gt; docset;
    Set&lt;String&gt; paraset;
    Set&lt;String&gt; symset2;
    Set&lt;String&gt; anaset2;
    Set&lt;String&gt; docset2;
    Set&lt;String&gt; paraset2;


<span class="nc" id="L29">    private static final Logger LOGGER = LoggerFactory.getLogger(QueryService.class);</span>

    @Autowired
<span class="nc" id="L32">    public QueryService(ParaContentService paraContentService,ExtractedDataService extractedDataService) {</span>
<span class="nc" id="L33">        this.paraContentService = paraContentService;</span>
<span class="nc" id="L34">        this.extractedDataService=extractedDataService;</span>
<span class="nc" id="L35">    }</span>
<span class="nc" id="L36">    public QueryService(){</span>

<span class="nc" id="L38">    }</span>

<span class="nc" id="L40">boolean flag2=false;</span>
<span class="nc" id="L41">    OutputResult outputResult2=null;</span>
<span class="nc" id="L42">    List&lt;OutputResult&gt; res2 = new ArrayList();</span>
    public List&lt;OutputResult&gt; runquery2(Driver driver, String k1, String k2) {
<span class="nc" id="L44">        LOGGER.info(&quot;received keywords from tagger2&quot;);</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">        if(!res2.isEmpty()){</span>
<span class="nc" id="L46">            res2.clear();</span>
        }
        String q;
<span class="nc" id="L49">        try (Session session = driver.session()) {</span>
<span class="nc" id="L50">            q=&quot;MATCH (A:&quot; + k2 + &quot;),p=(B)-[r]-(A) WHERE A.name contains '&quot; + k1 + &quot;' RETURN A.name As name1, labels(A) as name1label, TYPE(r) as ril, B.name As name, labels(B) as label, B.id as docId, B.paraId as paraId LIMIT 500&quot;;</span>

<span class="nc" id="L52">            try (Transaction tx = session.beginTransaction()) {</span>
<span class="nc" id="L53">                StatementResult result = tx.run(q);</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">                while (result.hasNext()) {</span>
<span class="nc" id="L55">                    Record record = result.next();</span>
<span class="nc" id="L56">                    flag2=false;</span>
<span class="nc" id="L57">                    LOGGER.info(&quot;query run&quot;);</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">                    for(OutputResult outputResult1:res2){</span>

<span class="nc bnc" id="L60" title="All 2 branches missed.">                        if(outputResult1.getDiseaseName().compareTo(record.get(&quot;name1&quot;).toString())==0){</span>
<span class="nc" id="L61">                            outputResult2=outputResult1;</span>
<span class="nc" id="L62">                            symset2=outputResult1.getSymptoms();</span>
<span class="nc" id="L63">                            anaset2=outputResult1.getAnatomy();</span>
<span class="nc" id="L64">                            docset2=outputResult1.getDoc();</span>
<span class="nc" id="L65">                            paraset2=outputResult1.getPara();</span>

<span class="nc" id="L67">                            flag2=true;</span>
                        }
<span class="nc" id="L69">                    }</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                    if(!flag2){</span>
<span class="nc" id="L71">                        outputResult2 = new OutputResult();</span>
<span class="nc" id="L72">                        symset2=new HashSet&lt;&gt;();</span>
<span class="nc" id="L73">                        anaset2=new HashSet&lt;&gt;();</span>
<span class="nc" id="L74">                        docset2=new HashSet&lt;&gt;();</span>
<span class="nc" id="L75">                        paraset2=new HashSet&lt;&gt;();</span>
<span class="nc" id="L76">                        outputResult2.setDiseaseName(record.get(&quot;name1&quot;).toString());</span>
                    }
<span class="nc" id="L78">                    String label=record.get(&quot;label&quot;).toString().substring(1,record.get(&quot;label&quot;).toString().length()-1);</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">                    if(label.equals(&quot;\&quot;MedicalSymptom\&quot;&quot;)){</span>
<span class="nc" id="L80">                        symset2.add(record.get(&quot;name&quot;).toString());</span>
                    }
<span class="nc bnc" id="L82" title="All 2 branches missed.">                    if(label.equals(&quot;\&quot;AnatomicalStructure\&quot;&quot;)){</span>
<span class="nc" id="L83">                        anaset2.add(record.get(&quot;name&quot;).toString());</span>
                    }
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    if(label.equals(&quot;\&quot;Document\&quot;&quot;)){</span>
<span class="nc" id="L86">                        String[] strlist =  record.get(&quot;docId&quot;).toString().substring(1,record.get(&quot;docId&quot;).toString().length()-1).split(&quot;,&quot;);</span>
<span class="nc" id="L87">                        List&lt;Integer&gt; docs=new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                        for(String s:strlist){</span>
<span class="nc" id="L89">                            docs.add(Integer.valueOf(s.trim()));</span>
                        }
<span class="nc bnc" id="L91" title="All 2 branches missed.">                        for(Integer i:docs){</span>
<span class="nc" id="L92">                            docset2.add(getdoc(i));</span>
<span class="nc" id="L93">                        }</span>
                    }
<span class="nc bnc" id="L95" title="All 2 branches missed.">                    if(label.equals(&quot;\&quot;Content\&quot;&quot;)) {</span>
<span class="nc" id="L96">                        String[] strlist =  record.get(&quot;paraId&quot;).toString().substring(1,record.get(&quot;paraId&quot;).toString().length()-1).split(&quot;,&quot;);</span>
<span class="nc" id="L97">                        List&lt;Integer&gt; para=new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                        for(String s:strlist){</span>
<span class="nc" id="L99">                            para.add(Integer.valueOf(s.trim()));</span>
                        }
<span class="nc bnc" id="L101" title="All 2 branches missed.">                        for(Integer i:para){</span>
<span class="nc" id="L102">                            paraset2.add(getpara(i));</span>
<span class="nc" id="L103">                        }</span>
<span class="nc" id="L104">                        Integer doc=  Integer.parseInt(record.get(&quot;docId&quot;).toString());</span>
<span class="nc" id="L105">                        docset2.add(getdoc(doc));</span>
                    }
<span class="nc" id="L107">                    LOGGER.info(&quot;Out of string loop&quot;);</span>
<span class="nc" id="L108">                    tx.success();  // Mark this write as successful.</span>
<span class="nc" id="L109">                    outputResult2.setSymptoms(symset2);</span>
<span class="nc" id="L110">                    outputResult2.setAnatomy(anaset2);</span>
<span class="nc" id="L111">                    outputResult2.setDoc(docset2);</span>
<span class="nc" id="L112">                    outputResult2.setPara(paraset2);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                    if(flag2)</span>
<span class="nc" id="L114">                        res2.remove(outputResult2);</span>
<span class="nc" id="L115">                    res2.add(outputResult2);</span>
<span class="nc" id="L116">                }</span>

            }
        }

<span class="nc" id="L121">        return res2;</span>
    }
<span class="nc" id="L123">boolean flag=false;</span>
<span class="nc" id="L124">    OutputResult outputResult=null;</span>
<span class="nc" id="L125">List&lt;OutputResult&gt; res = new ArrayList();</span>
    public List&lt;OutputResult&gt; runquery(Driver driver, String k1, String k2) {
<span class="nc" id="L127">        LOGGER.info(&quot;received keywords from tagger&quot;);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if(!res.isEmpty()){</span>
<span class="nc" id="L129">            res.clear();</span>
        }
        String q;
<span class="nc" id="L132">        try (Session session = driver.session()) {</span>
<span class="nc" id="L133">            q=&quot;MATCH (A:&quot; + k2 + &quot;),p=(B:MedicalCondition)-[r]-(A),j=(C)-[s]-(B:MedicalCondition) WHERE A.name contains '&quot; + k1 + &quot;' RETURN A.name As name1, labels(A) as name1label, TYPE(r) as ril, B.name As diseaseName, labels(B) as diseaseLabel, TYPE(s) AS sil, C.name As name3,C.id as docId,C.paraId as paraId, labels(C) As Ctype LIMIT 500&quot;;</span>
<span class="nc" id="L134">            try (Transaction tx = session.beginTransaction()) {</span>


<span class="nc" id="L137">                StatementResult result = tx.run(q);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                while (result.hasNext()) {</span>
<span class="nc" id="L139">                    Record record = result.next();</span>
<span class="nc" id="L140">                    flag=false;</span>
<span class="nc" id="L141">                LOGGER.info(&quot;query run&quot;);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                for(OutputResult outputResult1:res){</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                    if(outputResult1.getDiseaseName().compareTo(record.get(&quot;diseaseName&quot;).toString())==0){</span>
<span class="nc" id="L144">                        outputResult=outputResult1;</span>
<span class="nc" id="L145">                        symset=outputResult1.getSymptoms();</span>
<span class="nc" id="L146">                        anaset=outputResult1.getAnatomy();</span>
<span class="nc" id="L147">                        docset=outputResult1.getDoc();</span>
<span class="nc" id="L148">                        paraset=outputResult1.getPara();</span>

<span class="nc" id="L150">                        flag=true;</span>
                    }
<span class="nc" id="L152">                }</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                if(!flag){</span>
<span class="nc" id="L154">                    outputResult = new OutputResult();</span>
<span class="nc" id="L155">                    symset=new HashSet&lt;&gt;();</span>
<span class="nc" id="L156">                    anaset=new HashSet&lt;&gt;();</span>
<span class="nc" id="L157">                    docset=new HashSet&lt;&gt;();</span>
<span class="nc" id="L158">                    paraset=new HashSet&lt;&gt;();</span>
<span class="nc" id="L159">                    outputResult.setDiseaseName(record.get(&quot;diseaseName&quot;).toString());</span>
                }
<span class="nc" id="L161">                String ctype=record.get(&quot;Ctype&quot;).toString().substring(1,record.get(&quot;Ctype&quot;).toString().length()-1);</span>

<span class="nc bnc" id="L163" title="All 2 branches missed.">                if(ctype.equals(&quot;\&quot;MedicalSymptom\&quot;&quot;)){</span>
<span class="nc" id="L164">                    symset.add(record.get(&quot;name1&quot;).toString());</span>
<span class="nc" id="L165">                    symset.add(record.get(&quot;name3&quot;).toString());</span>
                }
<span class="nc bnc" id="L167" title="All 2 branches missed.">                if(ctype.equals(&quot;\&quot;AnatomicalStructure\&quot;&quot;)){</span>
<span class="nc" id="L168">                    anaset.add(record.get(&quot;name3&quot;).toString());</span>
                }
<span class="nc bnc" id="L170" title="All 2 branches missed.">                if(ctype.equals(&quot;\&quot;Document\&quot;&quot;)){</span>
<span class="nc" id="L171">                    String[] strlist =  record.get(&quot;docId&quot;).toString().substring(1,record.get(&quot;docId&quot;).toString().length()-1).split(&quot;,&quot;);</span>
<span class="nc" id="L172">                    List&lt;Integer&gt; docs=new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                    for(String s:strlist){</span>
<span class="nc" id="L174">                        docs.add(Integer.valueOf(s.trim()));</span>
                    }
<span class="nc bnc" id="L176" title="All 2 branches missed.">                    for(Integer i:docs){</span>
<span class="nc" id="L177">                        docset.add(getdoc(i));</span>
<span class="nc" id="L178">                    }</span>
                }
<span class="nc bnc" id="L180" title="All 2 branches missed.">                if(ctype.equals(&quot;\&quot;Content\&quot;&quot;)) {</span>
<span class="nc" id="L181">                    String[] strlist =  record.get(&quot;paraId&quot;).toString().substring(1,record.get(&quot;paraId&quot;).toString().length()-1).split(&quot;,&quot;);</span>
<span class="nc" id="L182">                    List&lt;Integer&gt; para=new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                    for(String s:strlist){</span>
<span class="nc" id="L184">                        para.add(Integer.valueOf(s.trim()));</span>
                    }
<span class="nc bnc" id="L186" title="All 2 branches missed.">                    for(Integer i:para){</span>
<span class="nc" id="L187">                        paraset.add(getpara(i));</span>
<span class="nc" id="L188">                    }</span>
<span class="nc" id="L189">                    Integer doc=  Integer.parseInt(record.get(&quot;docId&quot;).toString());</span>
<span class="nc" id="L190">                    docset.add(getdoc(doc));</span>
                }
<span class="nc" id="L192">                    LOGGER.info(&quot;Out of string loop&quot;);</span>
<span class="nc" id="L193">                    tx.success();  // Mark this write as successful.</span>
<span class="nc" id="L194">                    outputResult.setSymptoms(symset);</span>
<span class="nc" id="L195">                    outputResult.setAnatomy(anaset);</span>
<span class="nc" id="L196">                    outputResult.setDoc(docset);</span>
<span class="nc" id="L197">                    outputResult.setPara(paraset);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">                    if(flag)</span>
<span class="nc" id="L199">                        res.remove(outputResult);</span>
<span class="nc" id="L200">                    res.add(outputResult);</span>
<span class="nc" id="L201">                }</span>

            }
        }
<span class="nc" id="L205">        return res;</span>
    }
    public String getpara(int paraId){
        Optional&lt;ParaContent&gt; savedList;
<span class="nc" id="L209">        savedList = paraContentService.getParaById(paraId);</span>
<span class="nc" id="L210">        return savedList.get().getData();</span>
    }
    public String getdoc(Integer id){
<span class="nc" id="L213">        Optional&lt;ExtractedFileData&gt; doc=extractedDataService.getDocById(id);</span>
<span class="nc" id="L214">        String content=doc.get().getContent();</span>
<span class="nc" id="L215">        return content;</span>
    }
    public void loadgraph(Driver driver) {
<span class="nc" id="L218">        LOGGER.info(&quot;Loading The Graph&quot;);</span>
<span class="nc" id="L219">        try (Session session = driver.session()) {</span>
<span class="nc" id="L220">            String g1 = &quot;LOAD CSV WITH HEADERS FROM 'https://gist.githubusercontent.com/anand-jadhav/323d279c7b3ef477c5555a031b00da73/raw/e366c239441db747d507bbc603bb010f5698978c/sym_t.csv' AS line &quot; +</span>
                    &quot;CREATE (def:MedicalSymptom{syd:line.syd,name:line.symptom})&quot;;
<span class="nc" id="L222">            String g2 = &quot;LOAD CSV WITH HEADERS FROM 'https://gist.githubusercontent.com/anand-jadhav/f20082c9fd9db159cbd7101713ebfd9e/raw/721f1ccebac5fabfdec023aab3b489e1b9f0af96/dianew.csv' AS line &quot; +</span>
                    &quot;CREATE (def:MedicalCondition{did:line.did,name:line.diagnose})&quot;;
<span class="nc" id="L224">            String g3 =&quot;LOAD CSV WITH HEADERS FROM 'https://gist.githubusercontent.com/anand-jadhav/00eb984889a4b73247c336862bf79dfb/raw/286f104715cc41d0d04432f43a744aa1d1dd54d2/diffsydiw.csv' AS line &quot; +</span>
                    &quot;CREATE (def:Matchers{did:line.did,syd:line.syd})&quot;;
<span class="nc" id="L226">            String g4 = &quot;MATCH(a:MedicalCondition),(b:MedicalSymptom),(n:Matchers) &quot; +</span>
                    &quot;WHERE n.did=a.did AND n.syd=b.syd &quot; +
                    &quot;CREATE (a)-[r:has_symptom]-&gt;(b)&quot;;
<span class="nc" id="L229">            String g5= &quot;MATCH(A:Matchers) DELETE A&quot;;</span>
<span class="nc" id="L230">            try (Transaction tx = session.beginTransaction()) {</span>
<span class="nc" id="L231">                tx.run(g1);</span>
<span class="nc" id="L232">                tx.run(g2);</span>
<span class="nc" id="L233">                tx.run(g3);</span>
<span class="nc" id="L234">                tx.run(g4);</span>
<span class="nc" id="L235">                tx.run(g5);</span>
<span class="nc" id="L236">                tx.success();  // Mark this write as successful.</span>
<span class="nc" id="L237">                LOGGER.info(&quot;Graph Loaded Succesfully&quot;);</span>

            }
        }
<span class="nc" id="L241">    }</span>

    public void close(Driver driver) {
        // Closing a driver immediately shuts down all open connections.
<span class="nc" id="L245">        LOGGER.info(&quot;Closing Driver Session&quot;);</span>
<span class="nc" id="L246">        driver.close();</span>
<span class="nc" id="L247">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>